# template YAML file to create EVA YAML files
# based on obs spaces listed in JEDI YAML files
diagnostics:
- data:
    type: IodaObsSpace
    datasets:
      - name: experiment
        filenames:
          - @FILENAME@
        @CHANNELSKEY@
        groups:
          - name: ObsValue
            variables: &variables [absolute_dynamic_topography] 
          - name: ObsError
          - name: ombg
          - name: oman
          - name: hofx0
          - name: EffectiveQC0
          - name: MetaData
          - name: PreQC
          #- name: EffectiveError
  transforms:

    # bkg 
    - transform: arithmetic
      new name: experiment::bkg::${variable}
      equals: experiment::ObsValue::${variable}-experiment::ombg::${variable}
      for:
        variable: *variables

    # Generate hofx that passed QC for JEDI
    - transform: accept where
      new name: experiment::hofx0PassedQc::${variable}
      starting field: experiment::hofx0::${variable}
      where:
        - experiment::EffectiveQC0::${variable} == 0
      for:
        variable: *variables

    # Generate omb that passed QC for JEDI
    - transform: accept where
      new name: experiment::ombgPassedQc::${variable}
      starting field: experiment::ombg::${variable}
      where:
        - experiment::EffectiveQC0::${variable} == 0
      for:
        variable: *variables

    # Generate oma that passed QC for JEDI
    - transform: accept where
      new name: experiment::omanPassedQc::${variable}
      starting field: experiment::oman::${variable}
      where:
        - experiment::EffectiveQC0::${variable} == 0
      for:
        variable: *variables

    # Generate bkg that passed QC for JEDI
    - transform: accept where
      new name: experiment::bkgPassedQc::${variable}
      starting field: experiment::bkg::${variable}
      where:
        - experiment::EffectiveQC0::${variable} == 0
      for:
        variable: *variables


  graphics:

    # ---------- Map Plots ----------
    # Map plot of ObsValue 
    # --------

    - batch figure:
        variables: *variables
        @CHANNELSKEY@
      figure:
        layout: [1,1]
        figure size: [11,5]
        title: 'ObsValue | @NAME@ | ${variable_title}'
        output name: map_plots/@NAME@/${variable}/@CHANNELVAR@/obsvalue_@NAME@_${variable}@CHANNELVAR@.png
        #output name: map_plots/@CYCLE@/@NAME@/${variable}/observations_map_@NAME@_${variable}.png
        tight_layout: true
      plots:
        - mapping:
            projection: plcarr
            domain: global
          add_map_features: ['coastline']
          add_grid:
          add_colorbar:
          layers:
          - type: MapScatter
            longitude:
              variable: experiment::MetaData::longitude
            latitude:
              variable: experiment::MetaData::latitude
            data:
              variable: experiment::ObsValue::${variable}
              @CHANNELKEY@
            markersize: 2
            label: '$(variable)'
            colorbar: true
            # below may need to be edited/removed
            cmap: 'bwr'
            vmin: 0  #${dynamic_vmin}
            vmax: 1 # ${dynamic_vmax} 

    - batch figure:
        variables: *variables
        @CHANNELSKEY@
      figure:
        layout: [1,1]
        figure size: [11,5]
        title: 'ObsError | @NAME@ | ${variable_title}'
        output name: map_plots/@NAME@/${variable}/@CHANNELVAR@/obserror_@NAME@_${variable}@CHANNELVAR@.png
        #output name: map_plots/@CYCLE@/@NAME@/${variable}/observations_map_@NAME@_${variable}.png
        tight_layout: true
      plots:
        - mapping:
            projection: plcarr
            domain: global
          add_map_features: ['coastline']
          add_grid:
          add_colorbar:
          layers:
          - type: MapScatter
            longitude:
              variable: experiment::MetaData::longitude
            latitude:
              variable: experiment::MetaData::latitude
            data:
              variable: experiment::ObsError::${variable}
              @CHANNELKEY@
            markersize: 2
            label: '$(variable)'
            colorbar: true
            # below may need to be edited/removed
            cmap: 'bwr'
            vmin: 0  #${dynamic_vmin}
            vmax: 0.25 # ${dynamic_vmax} 

    # ---- plot oman -----
    - batch figure:
        variables: *variables
        @CHANNELSKEY@
      figure:
        layout: [1,1]
        figure size: [11,5]
        title: 'oman | @NAME@ | ${variable_title}'
        output name: map_plots/@NAME@/${variable}/@CHANNELVAR@/oman_@NAME@_${variable}@CHANNELVAR@.png
        tight_layout: true
      plots:
        - mapping:
            projection: plcarr
            domain: global
          add_map_features: ['coastline']
          add_grid:
          add_colorbar:
          layers:
          - type: MapScatter
            longitude:
              variable: experiment::MetaData::longitude
            latitude:
              variable: experiment::MetaData::latitude
            data:
              variable: experiment::omanPassedQc::${variable}
              @CHANNELKEY@
            markersize: 2
            label: '$(variable)'
            colorbar: true
            # below may need to be edited/removed
            cmap: 'bwr'
            vmin: 0 # ${dynamic_vmin}
            vmax: .2 # ${dynamic_vmax}

   # plot ombg
   #
    - batch figure:
        variables: *variables
        @CHANNELSKEY@
      figure:
        layout: [1,1]
        figure size: [11,5]
        title: 'ombg | @NAME@ | ${variable_title}'
        output name: map_plots/@NAME@/${variable}/@CHANNELVAR@/ombg_@NAME@_${variable}@CHANNELVAR@.png
        #output name: map_plots/@CYCLE@/@NAME@/${variable}/ombg_map_@NAME@_${variable}.png
        tight_layout: true
      plots:
        - mapping:
            projection: plcarr
            domain: global
          add_map_features: ['coastline']
          add_grid:
          add_colorbar:
          layers:
          - type: MapScatter
            longitude:
              variable: experiment::MetaData::longitude
            latitude:
              variable: experiment::MetaData::latitude
            data:
              variable: experiment::ombgPassedQc::${variable}
              @CHANNELKEY@
            markersize: 2
            label: '$(variable)'
            colorbar: true
            # below may need to be edited/removed
            cmap: 'bwr'
            vmin: 0 # ${dynamic_vmin}
            vmax: .2 # ${dynamic_vmax}


    - batch figure:
        variables: *variables
        @CHANNELSKEY@
      figure:
        layout: [1,1]
        figure size: [11,5]
        title: 'bkg | @NAME@ | ${variable_title}'
        output name: map_plots/@NAME@/${variable}/@CHANNELVAR@/bkg_@NAME@_${variable}@CHANNELVAR@.png
        #output name: map_plots/@CYCLE@/@NAME@/${variable}/bkg_@NAME@_${variable}.png
        tight_layout: true
      plots:
        - mapping:
            projection: plcarr
            domain: global
          add_map_features: ['coastline']
          add_grid:
          add_colorbar:
          layers:
          - type: MapScatter
            longitude:
              variable: experiment::MetaData::longitude
            latitude:
              variable: experiment::MetaData::latitude
            data:
              variable: experiment::bkgPassedQc::${variable}
              @CHANNELKEY@
            markersize: 2
            label: '$(variable)'
            colorbar: true
            # below may need to be edited/removed
            cmap: 'bwr'
            vmin: 0 #${dynamic_vmin}
            vmax: 1 # ${dynamic_vmax}


